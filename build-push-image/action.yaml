name: 'Build and Push Docker Image to GCR'
description: 'Builds and pushes a Docker image to Google Container Registry (GCR) based on the branch.'

inputs:
  github_token:
    description: 'GitHub Token para acessar registry privado'
    required: false
    default: ${{ github.token }}
 
outputs:
  IMAGE_TAG:
    description: 'Tag da imagem Docker.'
    value: ${{ steps.build.outputs.image_tag }}
  IMAGE_DIGEST:
    description: 'Digest da imagem Docker.'
    value: ${{ steps.build.outputs.image_digest }}

runs:
  using: 'composite'
  steps:
    - name: Set up variables
      id: vars
      shell: bash
      run: |
        # Gerar SHORT_SHA se não existir
        if [ -z "$SHORT_SHA" ]; then
          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
          echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
        fi
        
        # Garantir que GITHUB_REF_NAME esteja disponível
        if [ -z "$GITHUB_REF_NAME" ]; then
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            GITHUB_REF_NAME="${GITHUB_HEAD_REF}"
          else
            GITHUB_REF_NAME="${GITHUB_REF#refs/heads/}"
          fi
          echo "GITHUB_REF_NAME=$GITHUB_REF_NAME" >> $GITHUB_ENV
        fi
    
    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.github_token }}
    
    - name: Pull base image
      shell: bash
      run: |
        docker pull ghcr.io/platformbuilders/github-actions-bdsp-templates/build-push-image:latest
    
 
    - name: Run build and push
      id: build
      shell: bash
      run: |
        # Execute a lógica original usando a imagem como base
        # Monte o workspace no caminho esperado pelo seu entrypoint (/github/workspace)
        docker run --rm \
          -v ${{ github.workspace }}:/github/workspace \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v $HOME/.docker/config.json:/root/.docker/config.json:ro \
          -e GITHUB_TOKEN="${{ inputs.github_token }}" \
          -e GITHUB_ACTOR="${{ github.actor }}" \
          -e GITHUB_REPOSITORY \
          -e GITHUB_SHA \
          -e GITHUB_REF \
          -e GITHUB_REF_NAME \
          -e GITHUB_HEAD_REF \
          -e GITHUB_BASE_REF \
          -e GITHUB_EVENT_NAME \
          -e GITHUB_WORKSPACE="/github/workspace" \
          -e SHORT_SHA \
          -e GCP_SERVICE_ACCOUNT_KEY \
          -e AWS_SERVICE_ACCOUNT_KEY \
          -e AWS_SERVICE_ACCOUNT_KEY_PRD \
          -e DEPLOY_PROVIDER \
          -w /github/workspace \
          ghcr.io/platformbuilders/github-actions-bdsp-templates/build-push-image:latest
        
