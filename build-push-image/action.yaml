name: 'Build and Push Docker Image to GCR'
description: 'Builds and pushes a Docker image to Google Container Registry (GCR) based on the branch.'

inputs:
  github_token:
    description: 'GitHub Token para acessar registry privado'
    required: false
    default: ${{ github.token }}

outputs:
  IMAGE_TAG:
    description: 'Tag da imagem Docker.'
    value: ${{ steps.build.outputs.image_tag }}
  IMAGE_DIGEST:
    description: 'Digest da imagem Docker.'
    value: ${{ steps.build.outputs.image_digest }}

runs:
  using: 'composite'
  steps:
    - name: Set up variables
      id: vars
      shell: bash
      run: |
        if [ -z "$GITHUB_REF_NAME" ]; then
          if [ "$GITHUB_EVENT_NAME" = "pull_request" ]; then
            GITHUB_REF_NAME="${GITHUB_HEAD_REF}"
          else
            GITHUB_REF_NAME="${GITHUB_REF#refs/heads/}"
          fi
          echo "GITHUB_REF_NAME=$GITHUB_REF_NAME" >> $GITHUB_ENV
        fi
    
    - name: Login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ inputs.github_token }}
    
    - name: Pull base image
      shell: bash
      run: |
        docker pull ghcr.io/platformbuilders/github-actions-bdsp-templates/build-push-image:latest
    
    - name: Run build and push
      id: build
      shell: bash
      run: |
        TEMP_DIR=$(mktemp -d)
        OUTPUT_FILE="$TEMP_DIR/github_output.txt"
        touch "$OUTPUT_FILE"
        chmod 666 "$OUTPUT_FILE"
        
        docker run --rm \
          -v ${{ github.workspace }}:/github/workspace \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v "$OUTPUT_FILE":/tmp/github_output.txt \
          -e GITHUB_TOKEN="${{ inputs.github_token }}" \
          -e GITHUB_ACTOR="${{ github.actor }}" \
          -e GITHUB_REPOSITORY \
          -e GITHUB_SHA \
          -e GITHUB_REF \
          -e GITHUB_REF_NAME \
          -e GITHUB_HEAD_REF \
          -e GITHUB_BASE_REF \
          -e GITHUB_EVENT_NAME \
          -e GITHUB_OUTPUT="/tmp/outputs/github_output.txt" \
          -e GITHUB_OUTPUT="/tmp/github_output.txt" \
          -e SHORT_SHA \
          -e GCP_SERVICE_ACCOUNT_KEY \
          -e AWS_SERVICE_ACCOUNT_KEY \
          -e AWS_SERVICE_ACCOUNT_KEY_PRD \
          -e AWS_ACCESS_KEY_ID \
          -e AWS_SECRET_ACCESS_KEY \
          -e AWS_ACCESS_KEY_ID_PRD \
          -e AWS_SECRET_ACCESS_KEY_PRD \
          -e AWS_REGION \
          -e AWS_REGION_PRD \
          -e DEPLOY_PROVIDER \
          -w /github/workspace \
          ghcr.io/platformbuilders/github-actions-bdsp-templates/build-push-image:latest
        
        if [ -f "$OUTPUT_FILE" ]; then
          cat "$OUTPUT_FILE" >> $GITHUB_OUTPUT
        fi
        
        rm -f "$OUTPUT_FILE"
